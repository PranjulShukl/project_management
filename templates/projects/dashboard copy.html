{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block extra_css %}

<style>
  canvas {
    max-width: 100%;    /* fits container width */
    height: 300px !important;  /* reasonable height */
  }
</style>

{% endblock %}


{% block content %}
<div class="container mt-4">
  <h2>📊 Project Dashboard – {{ project.name }}</h2>
  <p><b>Company:</b> {{ project.company }} | <b>Location:</b> {{ project.location }}</p>
  <hr>

  <!-- Summary Cards -->
  <div class="row text-center">
    <div class="col-md-3">
      <div class="card bg-light shadow-sm">
        <div class="card-body">
          <h5>Total Hours</h5>
          <h3>{{ total_hours|default:0 }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-light shadow-sm">
        <div class="card-body">
          <h5>Avg Daily Hours</h5>
          <h3>{{ avg_daily_hours|default:0 }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-light shadow-sm">
        <div class="card-body">
          <h5>Active Days</h5>
          <h3>{{ active_days|default:0 }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-light shadow-sm">
        <div class="card-body">
          <h5>Days Left</h5>
          <h3>{{ days_left|default:0 }}</h3>
        </div>
      </div>
    </div>
  </div>

  <hr>

  <!-- Workload by User -->
  <h4>👨‍💻 Workload by User</h4>
  <canvas id="userChart"></canvas>

  <hr>

  <!-- Daily Trend -->
  <h4>📈 Daily Effort Trend</h4>
  <canvas id="trendChart"></canvas>

  <hr>

  <!-- Cumulative -->
  <h4>📊 Cumulative Hours</h4>
  <canvas id="cumulativeChart"></canvas>

  <hr>

  <!-- Idle Days -->
  <h4>⚠️ Idle Days</h4>
  {% if idle_days %}
    <ul>
      {% for gap in idle_days %}
        <li>{{ gap.from }} → {{ gap.to }} ({{ gap.days }} days)</li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No idle days 🚀</p>
  {% endif %}

</div>

<!-- Pass data safely to JS -->
{{ workload_by_user|json_script:"workload-data" }}
{{ daily_trend|json_script:"daily-trend-data" }}
{{ cumulative|json_script:"cumulative-data" }}

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const workloadData = JSON.parse(document.getElementById('workload-data').textContent);
  const dailyTrendData = JSON.parse(document.getElementById('daily-trend-data').textContent);
  const cumulativeData = JSON.parse(document.getElementById('cumulative-data').textContent);

  // Workload by user
  const userLabels = workloadData.map(u => u.user__username || 'Unknown');
  const userValues = workloadData.map(u => u.total || 0);

  const userChart = new Chart(document.getElementById('userChart'), {
    type: 'pie',
    data: {
      labels: userLabels,
      datasets: [{
        data: userValues,
        backgroundColor: ['#007bff','#28a745','#ffc107','#dc3545','#6f42c1']
      }]
    }
  });

  // Daily trend
  const trendLabels = dailyTrendData.map(d => d.date || '');
  const trendValues = dailyTrendData.map(d => d.total || 0);

  const trendChart = new Chart(document.getElementById('trendChart'), {
    type: 'bar',
    data: {
      labels: trendLabels,
      datasets: [{
        label: 'Hours',
        data: trendValues,
        backgroundColor: '#007bff'
      }]
    }
  });

  // Cumulative hours
  const cumulativeLabels = cumulativeData.map(c => c.date || '');
  const cumulativeValues = cumulativeData.map(c => c.cumulative || 0);

  const cumulativeChart = new Chart(document.getElementById('cumulativeChart'), {
    type: 'line',
    data: {
      labels: cumulativeLabels,
      datasets: [{
        label: 'Cumulative Hours',
        data: cumulativeValues,
        fill: true,
        borderColor: '#28a745',
        backgroundColor: 'rgba(40,167,69,0.2)'
      }]
    }
  });
</script>
{% endblock %}
